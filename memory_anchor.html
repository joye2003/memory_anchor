<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Joye's Memory Anchor (Mobile v3.1)</title>
    
    <!-- 1. ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ËºâÂÖ• React Âíå ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- 3. ËºâÂÖ• Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        /* PWA È¢®Ê†ºÂÑ™Âåñ */
        body { -webkit-tap-highlight-color: transparent; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out; }
        
        /* Èö±ËóèÂç∑Ëª∏ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 3D ÁøªËΩâÊïàÊûúÂÆπÂô® */
        .perspective-1000 { perspective: 1000px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-[100dvh] overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        // Ê™¢Êü• React
        if (typeof React === 'undefined') throw new Error("React not loaded");

        const { useState, useEffect, useRef } = React;

        // --- ÈåØË™§ÈÇäÁïå ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-6 h-full flex flex-col justify-center items-center text-center bg-white">
                            <h2 className="text-xl font-bold text-red-600 mb-2">ÁôºÁîü‰∫Ü‰∏ÄÈªûÂ∞èÂïèÈ°å üòì</h2>
                            <p className="text-sm text-gray-500 mb-6">{this.state.error?.toString()}</p>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-3 bg-red-500 text-white rounded-full shadow-lg font-medium active:scale-95 transition">ÈáçÁΩÆ App</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- Icons ---
        const Icon = ({ path, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{path}</svg>
        );
        const Icons = {
            Plus: (props) => <Icon path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} {...props} />,
            BookOpen: (props) => <Icon path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} {...props} />,
            Brain: (props) => <Icon path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} {...props} />,
            Check: (props) => <Icon path={<polyline points="20 6 9 17 4 12"/>} {...props} />,
            X: (props) => <Icon path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} {...props} />,
            Trash2: (props) => <Icon path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} {...props} />,
            RotateCcw: (props) => <Icon path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></>} {...props} />,
            Sparkles: (props) => <Icon path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></>} {...props} />,
            Volume2: (props) => <Icon path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></>} {...props} />,
            Loader2: (props) => <Icon path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} className={`animate-spin ${props.className || ''}`} {...props} />,
            ArrowUpDown: (props) => <Icon path={<><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></>} {...props} />,
            Key: (props) => <Icon path={<><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></>} {...props} />,
            ChevronLeft: (props) => <Icon path={<path d="m15 18-6-6 6-6"/>} {...props} />
        };

        const STORAGE_KEY = 'joye_vocab_mobile_data_v1';
        const API_KEY_STORAGE = 'joye_gemini_api_key';
        const INTERVALS = [0, 600000, 28800000, 86400000, 259200000, 604800000, 1209600000, 2592000000];
        const STAGE_LABELS = ["Êñ∞ÂñÆÂ≠ó", "10m", "‰ªäÊôö", "ÊòéÂ§©", "3Â§©", "7Â§©", "14Â§©", "1Êúà", "Á≤æÈÄö"];

        // --- Helper Functions ---
        const playPcmData = (pcmData, sampleRate) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const audioContext = new AudioContext();
                const buffer = audioContext.createBuffer(1, pcmData.length, sampleRate);
                const channelData = buffer.getChannelData(0);
                for (let i = 0; i < pcmData.length; i++) {
                    channelData[i] = pcmData[i] / 32768.0;
                }
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start();
            } catch(e) { console.error("Audio Error", e); }
        };

        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        };

        const extractEnglishForTTS = (text) => text ? text.split(/[\(Ôºà]/)[0].trim() : "";

        const makeClozeSentence = (text, targetWord) => {
            if (!text || !targetWord) return text;
            try {
                const escapedWord = targetWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                const regex = new RegExp(escapedWord, 'gi');
                return text.split(regex).reduce((prev, curr, i) => {
                    if (i === 0) return [curr];
                    return [...prev, <span key={i} className="inline-block w-12 border-b-2 border-teal-500 mx-1"></span>, curr];
                }, []);
            } catch(e) { return text; }
        };

        // --- Main Component ---
        function VocabularyApp() {
            const [words, setWords] = useState([]);
            const [view, setView] = useState('dashboard');
            const [newWord, setNewWord] = useState({ english: '', chinese: '', context: '' });
            const [showAnswer, setShowAnswer] = useState(false);
            const [sortType, setSortType] = useState('recent');
            const [userApiKey, setUserApiKey] = useState('');
            const [showApiKeyModal, setShowApiKeyModal] = useState(false);
            const [tempApiKeyInput, setTempApiKeyInput] = useState('');
            const [reviewQueue, setReviewQueue] = useState([]);
            const [currentReviewIndex, setCurrentReviewIndex] = useState(0);
            const [isAnalyzing, setIsAnalyzing] = useState(false); 
            const [isPlayingAudio, setIsPlayingAudio] = useState(null); 
            const [now, setNow] = useState(Date.now());
            
            // FIX: Âä†ÂÖ•ÂÑ≤Â≠òÁãÄÊÖãÁÆ°ÁêÜ
            const [saveStatus, setSaveStatus] = useState('idle'); // 'idle' | 'saved'

            useEffect(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) setWords(JSON.parse(saved));
                    
                    const savedKey = localStorage.getItem(API_KEY_STORAGE);
                    if (savedKey) setUserApiKey(savedKey);
                    else setTimeout(() => setShowApiKeyModal(true), 1500);
                } catch (e) { console.error("Storage Error", e); }
            }, []);

            useEffect(() => {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(words)); } catch(e) {}
            }, [words]);

            useEffect(() => {
                const timer = setInterval(() => setNow(Date.now()), 60000);
                return () => clearInterval(timer);
            }, []);

            const saveApiKey = () => {
                if(!tempApiKeyInput.trim()) return;
                try {
                    localStorage.setItem(API_KEY_STORAGE, tempApiKeyInput.trim());
                    setUserApiKey(tempApiKeyInput.trim());
                    setShowApiKeyModal(false);
                    setTempApiKeyInput('');
                } catch(e) {}
            };

            const getSortedWords = () => {
                const sorted = [...words];
                switch (sortType) {
                    case 'alpha': return sorted.sort((a, b) => a.english.toLowerCase().localeCompare(b.english.toLowerCase()));
                    case 'level_asc': return sorted.sort((a, b) => a.stage - b.stage);
                    case 'level_desc': return sorted.sort((a, b) => b.stage - a.stage);
                    case 'recent': default: return sorted.sort((a, b) => (b.addedDate || b.id) - (a.addedDate || a.id));
                }
            };

            const handleAddWord = (e) => {
                if(e) e.preventDefault(); // Èò≤Ê≠¢ form submit Âà∑Êñ∞È†ÅÈù¢
                if (!newWord.english || !newWord.chinese) return;
                
                const wordEntry = {
                    id: Date.now(),
                    ...newWord,
                    stage: 0, 
                    nextReview: Date.now(),
                    addedDate: Date.now(),
                    reviewCount: 0
                };
                setWords([...words, wordEntry]);
                setNewWord({ english: '', chinese: '', context: '' });
                
                // FIX: ‰ΩøÁî® State ÊéßÂà∂ÂõûÈ•ãÂãïÁï´ÔºåËÄåÈùûÊìç‰Ωú DOM
                setSaveStatus('saved');
                setTimeout(() => {
                    setSaveStatus('idle');
                }, 1000);
            };

            const dueWordsCount = words.filter(w => w.nextReview <= now).length;

            const startReviewSession = () => {
                const due = words.filter(w => w.nextReview <= Date.now()).sort((a, b) => a.nextReview - b.nextReview);
                if (due.length === 0) {
                    alert("ÁõÆÂâçÊ≤íÊúâÈúÄË¶ÅË§áÁøíÁöÑÂñÆÂ≠óÂñîÔºÅ");
                    return;
                }
                setReviewQueue(due);
                setCurrentReviewIndex(0);
                setShowAnswer(false);
                setView('review');
            };

            const handleReviewResult = (success) => {
                const currentQueueItem = reviewQueue[currentReviewIndex];
                if (!currentQueueItem) return;
                const originalWord = words.find(w => w.id === currentQueueItem.id); 
                
                let newStage = 0;
                let nextReviewTime = Date.now();
                let updatedReviewQueue = [...reviewQueue];

                if (originalWord) {
                    newStage = originalWord.stage;
                    if (success) {
                        newStage = Math.min(originalWord.stage + 1, INTERVALS.length - 1);
                        if (currentQueueItem.isRetry) newStage = 1; 
                        nextReviewTime = Date.now() + INTERVALS[newStage];
                    } else {
                        newStage = 0; 
                        nextReviewTime = Date.now(); 
                        updatedReviewQueue.push({ ...currentQueueItem, isRetry: true });
                        setReviewQueue(updatedReviewQueue);
                    }
                    setWords(words.map(w => w.id === originalWord.id ? { ...w, stage: newStage, nextReview: nextReviewTime, reviewCount: w.reviewCount + 1 } : w));
                }

                setShowAnswer(false);
                if (currentReviewIndex < updatedReviewQueue.length - 1) {
                    setCurrentReviewIndex(prev => prev + 1);
                } else {
                    alert("Â§™Ê£í‰∫ÜÔºÅÁõÆÂâçÁöÑÈÄ≤Â∫¶ÈÉΩË§áÁøíÂÆå‰∫ÜÔºÅ");
                    setView('dashboard');
                    setCurrentReviewIndex(0);
                }
            };

            const deleteWord = (id) => {
                if(window.confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) setWords(words.filter(w => w.id !== id));
            };

            const autoAnalyzeWord = async () => {
                if (!newWord.english) { alert("Ë´ãËº∏ÂÖ•Ëã±Êñá"); return; }
                if (!userApiKey) { setShowApiKeyModal(true); return; }
                setIsAnalyzing(true);
                try {
                    // Âº∑Âà∂Ë¶ÅÊ±Ç "Ëã±Êñá‰æãÂè• (‰∏≠ÊñáÁøªË≠Ø)" Ê†ºÂºè
                    const prompt = `Analyze "${newWord.english}". Output JSON: {"chinese": "Traditional Chinese meaning", "context": "English example sentence demonstrating the word. (Traditional Chinese translation)"}`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    const result = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
                    setNewWord(prev => ({ ...prev, chinese: result.chinese, context: result.context }));
                } catch (error) { console.error(error); alert("ÂàÜÊûêÂ§±Êïó"); } finally { setIsAnalyzing(false); }
            };

            const playPronunciation = async (text, id = 'temp') => {
                if (isPlayingAudio) return; 
                setIsPlayingAudio(id);
                try {
                    const textToSpeak = extractEnglishForTTS(text);
                    if (userApiKey) {
                         const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${userApiKey}`, {
                            method: "POST", headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ contents: [{ parts: [{ text: textToSpeak }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } })
                        });
                        const data = await response.json();
                        const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                        if (inlineData) playPcmData(new Int16Array(base64ToArrayBuffer(inlineData.data)), 24000);
                    } else throw new Error();
                } catch (error) { 
                    const u = new SpeechSynthesisUtterance(extractEnglishForTTS(text)); u.lang = 'en-US'; window.speechSynthesis.speak(u); 
                } finally { setTimeout(() => setIsPlayingAudio(null), 1500); }
            };

            // --- Mobile-First Views ---

            const renderDashboard = () => (
                <div className="flex flex-col h-full bg-gray-50 animate-fade-in">
                    {/* Header */}
                    <header className="bg-teal-600 text-white p-6 pb-12 rounded-b-[2.5rem] shadow-md flex-shrink-0 relative z-10">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h1 className="text-xl font-bold">Hi Joye üëã</h1>
                                <p className="text-teal-100 text-sm">‰ªäÂ§©‰πüË¶ÅÁ¥ØÁ©ç‰∏ÄÈªûÈªûÔºÅ</p>
                            </div>
                            <button onClick={() => setShowApiKeyModal(true)} className="p-2 bg-white/10 rounded-full backdrop-blur-sm"><Icons.Key size={18} /></button>
                        </div>
                        <div className="flex gap-3">
                            <div className="bg-white/10 p-3 rounded-2xl flex-1 backdrop-blur-md">
                                <div className="text-xs text-teal-100 mb-1">Á∏ΩÂñÆÂ≠ó</div>
                                <div className="text-2xl font-bold">{words.length}</div>
                            </div>
                            <div className="bg-white/10 p-3 rounded-2xl flex-1 backdrop-blur-md border border-white/20">
                                <div className="text-xs text-teal-100 mb-1">ÂæÖË§áÁøí</div>
                                <div className="text-2xl font-bold text-yellow-300">{dueWordsCount}</div>
                            </div>
                        </div>
                    </header>

                    {/* Action Cards */}
                    <div className="px-5 -mt-6 flex gap-3 z-20 flex-shrink-0">
                        <button onClick={() => setView('add')} className="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition">
                            <div className="bg-blue-50 p-3 rounded-full text-blue-500"><Icons.Plus size={24} /></div>
                            <span className="text-sm font-bold text-gray-700">Êñ∞Â¢ûÂñÆÂ≠ó</span>
                        </button>
                        <button onClick={startReviewSession} className={`flex-1 p-4 rounded-2xl shadow-sm border flex flex-col items-center justify-center gap-2 active:scale-95 transition ${dueWordsCount > 0 ? 'bg-white border-gray-100' : 'bg-gray-100 border-gray-200 opacity-60'}`}>
                            <div className={`p-3 rounded-full relative ${dueWordsCount > 0 ? 'bg-amber-50 text-amber-500' : 'bg-gray-200 text-gray-400'}`}>
                                <Icons.Brain size={24} />
                                {dueWordsCount > 0 && <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>}
                            </div>
                            <span className="text-sm font-bold text-gray-700">ÈñãÂßãË§áÁøí</span>
                        </button>
                    </div>

                    {/* Word List Area */}
                    <div className="flex-1 overflow-hidden flex flex-col mt-4">
                        <div className="px-5 pb-2 flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">ÂñÆÂ≠óÂ∫´</h3>
                            <div className="bg-white rounded-lg border border-gray-200 px-2 py-1 flex items-center gap-1">
                                <Icons.ArrowUpDown size={12} className="text-gray-400"/>
                                <select value={sortType} onChange={(e) => setSortType(e.target.value)} className="bg-transparent text-xs text-gray-600 outline-none appearance-none pr-2">
                                    <option value="recent">ÊúÄËøë</option><option value="alpha">A-Z</option><option value="level_asc">Lv ‚Üë</option>
                                </select>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-5 pb-20 space-y-3">
                            {words.length === 0 ? (
                                <div className="h-40 flex flex-col items-center justify-center text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded-2xl m-2">
                                    <Icons.BookOpen size={24} className="mb-2 opacity-50"/>
                                    ÈÇÑÊ≤íÊúâÂñÆÂ≠óÔºåÂø´ÂéªÊñ∞Â¢ûÔºÅ
                                </div>
                            ) : getSortedWords().map(word => (
                                <div key={word.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-start gap-3 active:bg-gray-50 transition">
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-bold text-lg text-gray-800 truncate">{word.english}</span>
                                            <button onClick={(e) => { e.stopPropagation(); playPronunciation(word.english, `word-${word.id}`); }} className={`p-1.5 rounded-full bg-gray-50 ${isPlayingAudio === `word-${word.id}` ? 'text-teal-500' : 'text-gray-400'}`}>
                                                {isPlayingAudio === `word-${word.id}` ? <Icons.Loader2 size={14} /> : <Icons.Volume2 size={14} />}
                                            </button>
                                        </div>
                                        <div className="text-sm text-gray-600 truncate mb-1">{word.chinese}</div>
                                        {word.context && (
                                            <div className="text-xs text-gray-400 line-clamp-2 italic bg-gray-50 p-1.5 rounded">
                                                {word.context}
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex flex-col items-end gap-2">
                                        <span className={`text-[10px] px-2 py-1 rounded-full font-bold ${word.nextReview <= now ? 'bg-red-50 text-red-500' : 'bg-teal-50 text-teal-600'}`}>
                                            {word.nextReview <= now ? 'Ë§áÁøí!' : `Lv.${word.stage}`}
                                        </span>
                                        <button onClick={(e) => { e.stopPropagation(); deleteWord(word.id); }} className="text-gray-300 p-1 hover:text-red-400"><Icons.Trash2 size={16}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const renderAddWord = () => (
                <div className="flex flex-col h-full bg-white animate-fade-in-up">
                    <div className="p-4 border-b border-gray-100 flex items-center gap-3 sticky top-0 bg-white/80 backdrop-blur-md z-10">
                        <button onClick={() => setView('dashboard')} className="p-2 -ml-2 text-gray-600 active:scale-95"><Icons.ChevronLeft size={24}/></button>
                        <h2 className="font-bold text-lg text-gray-800">Êñ∞Â¢ûÂñÆÂ≠ó</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-5 pb-32">
                        <form onSubmit={handleAddWord} className="space-y-6">
                            <div className="space-y-2">
                                <label className="text-sm font-bold text-gray-700">Ëã±ÊñáÂñÆÂ≠ó</label>
                                <div className="flex gap-2">
                                    <input type="text" required className="flex-1 p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-teal-500 outline-none text-lg font-bold text-base" placeholder="Generate" value={newWord.english} onChange={e => setNewWord({...newWord, english: e.target.value})} />
                                    <button type="button" onClick={autoAnalyzeWord} disabled={isAnalyzing} className={`px-4 rounded-2xl font-bold flex flex-col items-center justify-center min-w-[80px] transition active:scale-95 ${isAnalyzing ? 'bg-gray-100 text-gray-400' : 'bg-indigo-100 text-indigo-600'}`}>
                                        {isAnalyzing ? <Icons.Loader2 size={20} /> : <Icons.Sparkles size={20} />}
                                        <span className="text-[10px] mt-1">ÂàÜÊûê</span>
                                    </button>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-bold text-gray-700">‰∏≠ÊñáÊÑèÊÄù</label>
                                <input type="text" required className="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-teal-500 outline-none text-base" placeholder="Áî¢Áîü" value={newWord.chinese} onChange={e => setNewWord({...newWord, chinese: e.target.value})} />
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-bold text-gray-700 flex justify-between">
                                    <span>ÂØ¶Áî®‰æãÂè•</span>
                                    <span className="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">AI ÁîüÊàê</span>
                                </label>
                                <textarea className="w-full p-4 bg-amber-50 rounded-2xl border-none focus:ring-2 focus:ring-amber-400 outline-none text-base min-h-[120px]" placeholder="‰æãÂ¶Ç: The new policy..." value={newWord.context} onChange={e => setNewWord({...newWord, context: e.target.value})} />
                            </div>
                        </form>
                    </div>

                    {/* Fixed Bottom Button - FIX: Updated styles based on state */}
                    <div className="absolute bottom-0 left-0 right-0 p-5 bg-white border-t border-gray-100">
                        <button 
                            onClick={handleAddWord} 
                            className={`w-full py-4 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2 ${saveStatus === 'saved' ? 'bg-green-600 shadow-green-200' : 'bg-teal-600 shadow-teal-200'}`}
                        >
                            {saveStatus === 'saved' ? (
                                <><Icons.Check size={20} /> Â∑≤ÂÑ≤Â≠òÔºÅ</>
                            ) : (
                                <><Icons.Check size={20} /> Â≠òÂÖ•Ë®òÊÜ∂Â∫´</>
                            )}
                        </button>
                    </div>
                </div>
            );

            const renderReview = () => {
                if (reviewQueue.length === 0) return null;
                const item = reviewQueue[currentReviewIndex];
                
                return (
                    <div className="flex flex-col h-full bg-gray-100 relative">
                        {/* Top Bar */}
                        <div className="p-4 flex justify-between items-center text-gray-500">
                            <button onClick={() => setView('dashboard')} className="p-2 -ml-2"><Icons.X size={24}/></button>
                            <span className="text-xs font-mono bg-gray-200 px-3 py-1 rounded-full">{currentReviewIndex + 1} / {reviewQueue.length}</span>
                        </div>

                        {/* Card Area */}
                        <div className="flex-1 px-4 pb-4 flex flex-col justify-center">
                            <div className={`w-full bg-white rounded-[2rem] shadow-xl p-6 flex flex-col items-center justify-center text-center transition-all duration-300 min-h-[50vh] ${showAnswer ? 'ring-4 ring-teal-50' : ''}`}>
                                
                                {item.isRetry && <div className="mb-6 px-3 py-1 bg-red-100 text-red-500 text-xs font-bold rounded-full">Retry Mode</div>}
                                
                                <div className="w-full mb-8">
                                    <div className="text-xs uppercase text-gray-400 font-bold tracking-widest mb-3">‰∏≠ÊñáÊèêÁ§∫</div>
                                    <h2 className="text-3xl font-bold text-gray-800 mb-8 leading-tight">{item.chinese}</h2>
                                    
                                    <div className="text-left bg-amber-50 p-5 rounded-2xl border border-amber-100 relative">
                                        <div className="text-xs text-amber-400 font-bold mb-2 uppercase">Cloze Test</div>
                                        <div className="text-lg text-amber-900 leading-relaxed font-medium">
                                            {makeClozeSentence(item.context, item.english)}
                                        </div>
                                        <button onClick={(e) => {e.stopPropagation(); playPronunciation(item.context)}} className="absolute top-4 right-4 text-amber-400 p-2"><Icons.Volume2 size={20}/></button>
                                    </div>
                                </div>

                                {!showAnswer ? (
                                    <button onClick={() => setShowAnswer(true)} className="w-full py-4 bg-blue-500 text-white rounded-2xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-95 transition mt-auto">
                                        È°ØÁ§∫Á≠îÊ°à
                                    </button>
                                ) : (
                                    <div className="w-full animate-fade-in mt-auto">
                                        <div className="mb-6">
                                            <div className="text-3xl font-black text-teal-600 flex items-center justify-center gap-2">
                                                {item.english}
                                                <button onClick={() => playPronunciation(item.english)} className="p-2 bg-teal-50 rounded-full text-teal-500"><Icons.Volume2 size={20}/></button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => handleReviewResult(false)} className="py-4 bg-red-50 text-red-500 rounded-2xl font-bold border border-red-100 active:scale-95 flex flex-col items-center justify-center gap-1">
                                                <Icons.X size={24} />
                                                <span className="text-xs opacity-70">Èáç‰æÜ</span>
                                            </button>
                                            <button onClick={() => handleReviewResult(true)} className="py-4 bg-green-500 text-white rounded-2xl font-bold shadow-lg shadow-green-200 active:scale-95 flex flex-col items-center justify-center gap-1">
                                                <Icons.Check size={24} />
                                                <span className="text-xs opacity-70">‰∏ãÊ¨°: {STAGE_LABELS[Math.min(item.stage + 1, 8)]}</span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const renderApiKeyModal = () => (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-5">
                    <div className="bg-white p-6 rounded-[2rem] w-full max-w-sm shadow-2xl animate-fade-in-up">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center mx-auto mb-3"><Icons.Key size={24}/></div>
                            <h3 className="text-xl font-bold text-gray-800">Ë®≠ÂÆö Gemini API</h3>
                            <p className="text-sm text-gray-500 mt-2">Ë´ãËº∏ÂÖ•ÈáëÈë∞‰ª•ÂïüÁî® AI ÂäüËÉΩ</p>
                        </div>
                        <input type="password" placeholder="Ë≤º‰∏ä API Key" className="w-full p-4 bg-gray-50 rounded-2xl text-center font-mono text-sm mb-4 outline-none border border-transparent focus:border-teal-500 focus:bg-white transition" value={tempApiKeyInput} onChange={(e) => setTempApiKeyInput(e.target.value)} />
                        <div className="flex gap-3">
                            <button onClick={() => setShowApiKeyModal(false)} className="flex-1 py-3 text-gray-400 font-bold rounded-xl active:bg-gray-50">Áï•ÈÅé</button>
                            <button onClick={saveApiKey} className="flex-1 py-3 bg-teal-600 text-white font-bold rounded-xl shadow-lg shadow-teal-200 active:scale-95">ÂÑ≤Â≠ò</button>
                        </div>
                    </div>
                </div>
            );

            // --- Root Render ---
            return (
                <ErrorBoundary>
                    <div className="max-w-md mx-auto h-full shadow-2xl bg-white overflow-hidden relative">
                        {showApiKeyModal && renderApiKeyModal()}
                        {view === 'dashboard' && renderDashboard()}
                        {view === 'add' && renderAddWord()}
                        {view === 'review' && renderReview()}
                    </div>
                </ErrorBoundary>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VocabularyApp />);
    </script>
</body>
</html>